name: Frontend Web CI/CD Pipeline

on:
  workflow_call:
    inputs:
      system-dir:
        required: true
        type: string
        description: 'Project directory name (e.g. pakiPARK-Web)'
      sonar-organization:
        required: false
        type: string
        default: 'implementsprint'
        description: 'SonarCloud organization'
      coverage-threshold:
        required: false
        type: number
        default: 80
        description: 'Minimum code coverage percentage'
    secrets:
      SONAR_TOKEN:
        required: true
      SONAR_PROJECT_KEY:
        required: true
      SONAR_ORGANIZATION:
        required: false

jobs:
  # ── Stage 1: Governance Checks ──────────────────────────────────
  web-governance:
    name: Web — Governance Checks
    uses: ./.github/workflows/governance-check.yml
    with:
      working-directory: ${{ inputs.system-dir }}
      test-command: 'npx react-scripts test --coverage --watchAll=false --passWithNoTests'
      coverage-threshold: ${{ inputs.coverage-threshold }}

  # ── Stage 2a: Build Web Application ─────────────────────────────
  web-build:
    name: Web — Build
    needs: web-governance
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./${{ inputs.system-dir }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: ${{ inputs.system-dir }}/package-lock.json

      - name: Install Dependencies
        run: npm ci

      - name: Build Application
        run: npm run build

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.system-dir }}-web-build
          path: ${{ inputs.system-dir }}/build
          retention-days: 14

  # ── Stage 2b: SonarCloud Quality Gate ───────────────────────────
  web-sonarcloud:
    name: Web — SonarCloud Analysis
    needs: web-governance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Coverage Report
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.system-dir }}-coverage
          path: ${{ inputs.system-dir }}/coverage

      - name: Validate SonarCloud Configuration
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
          SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION || inputs.sonar-organization }}
        run: |
          set -euo pipefail

          if [ -z "${SONAR_TOKEN:-}" ]; then
            echo "::error::SONAR_TOKEN is missing. Add it in repository or organization secrets."
            exit 1
          fi

          if [ -z "${SONAR_PROJECT_KEY:-}" ]; then
            echo "::error::SONAR_PROJECT_KEY is missing. Add it in repository or organization secrets."
            exit 1
          fi

          echo "Checking SonarCloud project '${SONAR_PROJECT_KEY}' in organization '${SONAR_ORGANIZATION}'..."
          STATUS_CODE=$(curl -sS -o sonar-project-check.json -w "%{http_code}" -u "${SONAR_TOKEN}:" "https://sonarcloud.io/api/projects/search?organization=${SONAR_ORGANIZATION}&projects=${SONAR_PROJECT_KEY}")

          if [ "${STATUS_CODE}" != "200" ]; then
            echo "::error::SonarCloud preflight failed (HTTP ${STATUS_CODE}). Verify SONAR_TOKEN permissions and organization/project values."
            cat sonar-project-check.json
            exit 1
          fi

          if ! grep -q '"key":"'"${SONAR_PROJECT_KEY}"'"' sonar-project-check.json; then
            echo "::error::Project '${SONAR_PROJECT_KEY}' was not found under organization '${SONAR_ORGANIZATION}'."
            cat sonar-project-check.json
            exit 1
          fi

          echo "SonarCloud preflight passed."

      - name: Run SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v5.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: ${{ inputs.system-dir }}
          args: >
            -Dsonar.host.url=https://sonarcloud.io
            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION || inputs.sonar-organization }}
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            -Dsonar.sources=src
            -Dsonar.tests=src
            -Dsonar.test.inclusions=src/**/*.test.js,src/**/*.test.jsx,src/**/*.spec.js,src/**/*.spec.jsx
            -Dsonar.exclusions=src/**/*.test.js,src/**/*.test.jsx,src/**/*.spec.js,src/**/*.spec.jsx
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
