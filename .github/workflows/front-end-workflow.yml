name: Frontend Web CI/CD Pipeline

on:
  workflow_call:
    inputs:
      system-dir:
        required: true
        type: string
        description: 'Project directory name (e.g. pakiPARK-Web)'
      sonar-organization:
        required: false
        type: string
        default: 'implementsprint'
        description: 'SonarCloud organization'
      coverage-threshold:
        required: false
        type: number
        default: 80
        description: 'Minimum code coverage percentage'
    secrets:
      SONAR_TOKEN:
        required: false
      SONAR_PROJECT_KEY:
        required: false

jobs:
  # ── Stage 1: Governance Checks ──────────────────────────────────
  web-governance:
    name: Web — Governance Checks
    uses: ./.github/workflows/governance-check.yml
    with:
      working-directory: ${{ inputs.system-dir }}
      test-command: 'npx react-scripts test --coverage --watchAll=false --passWithNoTests'
      coverage-threshold: ${{ inputs.coverage-threshold }}

  # ── Stage 2a: Build Web Application ─────────────────────────────
  web-build:
    name: Web — Build
    needs: web-governance
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./${{ inputs.system-dir }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: ${{ inputs.system-dir }}/package-lock.json

      - name: Install Dependencies
        run: npm ci

      - name: Build Application
        run: npm run build

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.system-dir }}-web-build
          path: ${{ inputs.system-dir }}/build
          retention-days: 14

  # ── Stage 2b: SonarCloud Quality Gate ───────────────────────────
  web-sonarcloud:
    name: Web — SonarCloud Analysis
    needs: web-governance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Coverage Report
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.system-dir }}-coverage
          path: ${{ inputs.system-dir }}/coverage

      - name: Run SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v5.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: ${{ inputs.system-dir }}
          args: >
            -Dsonar.organization=${{ inputs.sonar-organization }}
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            -Dsonar.sources=src
            -Dsonar.tests=src
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
