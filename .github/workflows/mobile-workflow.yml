name: Mobile CI/CD Pipeline

on:
  workflow_call:
    inputs:
      system-dir:
        required: true
        type: string
        description: 'Project directory name (e.g. pakiPARK-Mobile)'
      sonar-project-key:
        required: false
        type: string
        default: ''
        description: 'SonarCloud project key'
      sonar-organization:
        required: false
        type: string
        default: 'implementsprint'
        description: 'SonarCloud organization'
      coverage-threshold:
        required: false
        type: number
        default: 80
        description: 'Minimum code coverage percentage'

jobs:
  # ── Stage 1: Governance Checks ──────────────────────────────────
  mobile-governance:
    name: Mobile — Governance Checks
    uses: ./.github/workflows/governance-check.yml
    with:
      working-directory: ${{ inputs.system-dir }}
      test-command: 'npx jest --coverage --ci --reporters=default'
      coverage-threshold: ${{ inputs.coverage-threshold }}

  # ── Stage 2a: Build Android ─────────────────────────────────────
  mobile-build-android:
    name: Mobile — Build Android
    needs: mobile-governance
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./${{ inputs.system-dir }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: ${{ inputs.system-dir }}/package-lock.json

      - name: Setup Java (Android SDK)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install Dependencies
        run: npm ci

      - name: Build Android APK
        run: |
          if [ -d "android" ]; then
            cd android && chmod +x gradlew && ./gradlew assembleRelease --no-daemon
          else
            echo "⚠️ No android directory found — skipping Android build"
          fi

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ${{ inputs.system-dir }}-android-apk
          path: ${{ inputs.system-dir }}/android/app/build/outputs/apk/release/*.apk
          retention-days: 14

  # ── Stage 2b: SonarCloud Quality Gate ───────────────────────────
  mobile-sonarcloud:
    name: Mobile — SonarCloud Analysis
    needs: mobile-governance
    if: ${{ inputs.sonar-project-key != '' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Coverage Report
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.system-dir }}-coverage
          path: ${{ inputs.system-dir }}/coverage

      - name: Run SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v5.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: ${{ inputs.system-dir }}
          args: >
            -Dsonar.organization=${{ inputs.sonar-organization }}
            -Dsonar.projectKey=${{ inputs.sonar-project-key }}
            -Dsonar.sources=src
            -Dsonar.tests=src
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
